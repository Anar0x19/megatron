#include "msockaddr_in.h"
#ifndef _WIN32
#include <netdb.h>
#endif
#include "commonError.h"
#include "mutexInspector.h"
#include "url.h"


outBuffer & operator<<(outBuffer&b,const msockaddr_in &a)
{
    return a.pack(b);
}
inBuffer & operator>>(inBuffer &b,msockaddr_in &a)
{
    return a.unpack(b);
}

int msockaddr_in::cmp(const msockaddr_in& b)const
{
    for(int i=0;i<4;i++)
    {
        if (sin6_addr.__u6_addr.__u6_addr32[i]<b.sin6_addr.__u6_addr.__u6_addr32[i]) return true;
        if (sin6_addr.__u6_addr.__u6_addr32[i]>b.sin6_addr.__u6_addr.__u6_addr32[i]) return false;

    }

    if (sin6_port<b.sin6_port) return true;
    if (sin6_port>b.sin6_port) return false;

    return false;
}

outBuffer &msockaddr_in::pack(outBuffer &b) const
{
    b.put_PN(sin6_family);
    b.put_PN(htons(sin6_port));
    /*
struct sockaddr_in sa;
char str[INET_ADDRSTRLEN];

// store this IP address in sa:
inet_pton(AF_INET, "192.0.2.33", &(sa.sin_addr));

// now get it back and print it
inet_ntop(AF_INET, &(sa.sin_addr), str, INET_ADDRSTRLEN);

printf("%s\n", str); // prints "192.0.2.33"*/
    char str[100];
    inet_ntop(sin6_family, &sin6_addr, str,sizeof(str));
    b.put_PSTR(str);
    //for(int i=0;i<4;i++)
      //  b.put_PN(sin6_addr.__u6_addr.__u6_addr32[i]);
    return b;
}
inBuffer &msockaddr_in::unpack(inBuffer&b)
{
    sin6_family=b.get_PN();
    sin6_port=ntohs(b.get_PN());
    std::string s=b.get_PSTR();
    inet_pton(sin6_family,s.c_str(),&sin6_addr);
//    for(int i=0;i<4;i++)
//        sin_addr.s_addr=b.get_PN();
    return b;
}
std::string msockaddr_in::getStringAddr() const
{
    char str[100];
    inet_ntop(sin6_family, &sin6_addr, str,sizeof(str));
    return str;
}
unsigned short msockaddr_in::port() const
{
    return ntohs(sin6_port);
}
std::string msockaddr_in::inaddr() const
{
    return getStringAddr();
//    return ntohl(sin_addr.s_addr);
}

msockaddr_in::msockaddr_in(const msockaddr_in& n)
{
    sin6_family=n.sin6_family;
    sin6_port=n.sin6_port;
    sin6_addr=n.sin6_addr;
}
std::string msockaddr_in::dump() const
{
    char s[200];
    snprintf(s,sizeof(s),"%s:%d",getStringAddr().c_str(), ntohs(sin6_port));
    return s;

}


void msockaddr_in::init(const char* host, unsigned short port)
{
    XTRY;
    sin6_port=htons(port);
    bool isA=false;
    size_t len=strlen(host);
    for(size_t i=0; i<len; i++)
    {
        if(host[i]>='a'&& host[i]<'z') isA=true;
        if(host[i]>='A'&& host[i]<'Z') isA=true;

    }

    if(!isA)
    {
        inet_pton(sin6_family,host,&sin6_addr);
//        sin_addr.s_addr=inet_addr(host);
    }
    else
    {
        uint32_t addr;
        if(iUtils->getHostByName(host,addr))
        {
            throw CommonError("getHostByName: (%s) errno %d %s",host,errno,_DMI().c_str());
        }
        sin_addr.s_addr=addr;
    }
    XPASS;
}
void msockaddr_in::setPort(const unsigned short& port)
{
    sin_port=htons(port);
}
void msockaddr_in::init(const Url& u)
{
    init(u.host.c_str(),atoi(u.port.c_str()));
}
void msockaddr_in::setInaddr(const std::string &v)
{
    sin_addr.s_addr=htonl(v);
}

static bool check_addr_for_mask(in_addr a, const char *ipmask, int maskShift)
{
    unsigned int val;
    unsigned char *ps=(unsigned char *)&a.s_addr;
    unsigned char *pd=(unsigned char *)&val;
    pd[0]=ps[3];
    pd[1]=ps[2];
    pd[2]=ps[1];
    pd[3]=ps[0];

    int shift=32-maskShift;
    val>>=shift;
    val<<=shift;

    ps[0]=pd[3];
    ps[1]=pd[2];
    ps[2]=pd[1];
    ps[3]=pd[0];
    std::string rest=inet_ntoa(a);
    return rest==ipmask;

}
bool msockaddr_in::isNAT() const
{
    /**
        10.0.0.0/8       (10.0.0.0 - 10.255.255.255)
        172.16.0.0/12    (172.16.0.0 - 172.31.255.255)
        192.168.0.0/16   (192.168.0.0 - 192.168.255.255)

    */
    if(check_addr_for_mask(sin_addr,"10.0.0.0",8))
        return true;
    if(check_addr_for_mask(sin_addr,"172.16.0.0",12))
        return true;
    if(check_addr_for_mask(sin_addr,"192.168.0.0",16))
        return true;
    return false;
}
std::string  msockaddr_in::asString() const
{
    outBuffer o;
    pack(o);
    return o.asString()->asString();
}
msockaddr_in::msockaddr_in(const std::string &url)
{
    Url u;
    u.parse(url);
    init(u);
}
